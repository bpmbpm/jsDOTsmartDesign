<html lang="Ru"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>jsDOTSmartDesign</title> 
<script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
<link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />
<script src="https://jsuites.net/v4/jsuites.js"></script>
<link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />

 <head>
 <!-- <script src="./viz-standalone.js"></script> -->
 </head> 
 <body>
<h1>jsDOT SmartDesign: ïîñòðîåíèå ñõåìû ïðîöåññà (DOT) ïî òàáëè÷íîìó îïèñàíèþ</h1>
<p>Â ïðîñòåéøåì ñëó÷àå - ïðîñòî íàæàòü "Ñõåìà"</p>
<div id="spreadsheet1"></div>
<p id="p">Âûáîð EPC/VAD:</p>
<select id="EPC_VAD">
  <option value="EPC" selected="">EPC</option>
  <option value="VAD">VAD</option>
</select>
<button onclick="Button1()">Ñõåìà</button>

<script>
var data = [
    ['ñîáûòèå', 'Íà÷àëüíîå ñîáûòèå', '', '', '', '', ''],
    ['îïåðàöèÿ', 'Çàïîëíåíèå è ïå÷àòü äîâåðåííîñòè', 'Äîâåðåííîñòü øàáëîí', 'Äîâåðåííîñòü ðàñïå÷àòàííàÿ', 'Ïîìîùíèê íîòàðèóñà', '', ''],
    ['îïåðàöèÿ', 'Ïðîâåðêà è ïîäïèñàíèå äîâåðåííîñòè', 'Äîâåðåííîñòü ðàñïå÷àòàííàÿ', 'Äîâåðåííîñòü ïîäïèñàííàÿ', 'Äîâåðèòåëü', '', ''],
    ['îïåðàöèÿ', 'Ïðîâåðêà è çàâåðåíèå äîâåðåííîñòè', 'Äîâåðåííîñòü ïîäïèñàííàÿ', 'Äîâåðåííîñòü çàâåðåííàÿ', 'Íîòàðèóñ', '', ''],
    ['ñîáûòèå', 'Ôèíàëüíîå ñîáûòèå', '', '', '', '', ''],
];
 
 // https://codepen.io/hchiam/pen/qBRzXKK
table1 = jexcel(document.getElementById('spreadsheet1'), {

    data:data,
    columns: [
        {
            type: 'dropdown',
            title:'Ñïèñîê_Òèïîâ',
            width:110,
            source:[
                "ñîáûòèå",
                "îïåðàöèÿ",
                ]
        },
        {
            type: 'text',
            title:'Èìÿ ñîáûòèÿ èëè ôóíêöèè',
            width:300
        },
        {
            type: 'dropdown',
            title:'Âõîäÿùèé äîêóìåíò',
            width:250,
            source:[
                "Äîâåðåííîñòü øàáëîí",
                "Äîâåðåííîñòü ðàñïå÷àòàííàÿ",
                "Äîâåðåííîñòü ïîäïèñàííàÿ",
                "Äîâåðåííîñòü çàâåðåííàÿ",
                "Êîïèÿ çàâåðåííàÿ",
                ]
         },
        {
            type: 'dropdown',
            title:'Èñõîäÿùèé äîêóìåíò',
            width:250,
            source:[
                "Äîâåðåííîñòü øàáëîí",
                "Äîâåðåííîñòü ðàñïå÷àòàííàÿ",
                "Äîâåðåííîñòü ïîäïèñàííàÿ",
                "Äîâåðåííîñòü çàâåðåííàÿ",
                "Êîïèÿ çàâåðåííàÿ",
                ]
        },
        {
            type: 'dropdown',
            title:'Ñïèñîê_Ðîëåé',
            width:200,
            source:[
                "Ïîìîùíèê íîòàðèóñà",
                "Äîâåðèòåëü",
                "Íîòàðèóñ",
                ]
        },
        {
            type: 'dropdown',
            title:'Ñïèñîê_Ñèñòåì',
            width:80,
            source:[
                "MS Word",
                "Internet",
                ]
        },
        {
            type: 'text',
            title:'Ïðèì',
            width:40
        },
     ]
});

// Êîíñòàíòû èç Excel (exDOT SmartDesign)
//Public Const idWF As Integer = 2, predWF = 3, fixTypeEvFun = 4 ' A - D: ID, ïðåäûäóùèé è òèï
//Public Const nameEvFun As Integer = 5, idEvFun = 6, labelEvFun = 7, nLinkWF = 8  ' E - F - G - H: Ôóíêöèÿ \ ñîáûòèå + nLinkWF
//Public Const nameHasInDoc As Integer = 9, idHasInDoc = 10, labelHasInDoc = 11 ' I - J - K: Âõîäÿùèé äîêóìåíò
//Public Const nameHasOutDoc As Integer = 12, idHasOutDoc = 13, labelHasOutDoc = 14 ' L - M - N: Âõîäÿùèé äîêóìåíò
//Public Const nameRole As Integer = 15, idRole = 16, labelRole = 17 ' O - P - Q: Role
//Public Const nameSystem As Integer = 18, idSystem = 19, labelSystem = 20 ' R - S - T: System

const fixTypeEvFun = 0, nameEvFun = 1;
const nameHasInDoc = 2, nameHasOutDoc = 3;
const nameRole = 4, nameSystem = 5;
let txtStream; // = ""; // ñòðîêà ñ èòîãîâûì DOT ñêðèïòîì

const StEndStart = ['digraph G {', 'digraph G {rankdir="LR"'];
const DOTstyle = [ // Ëèñò èç Excel (exDOT SmartDesign)             // EPC / VAD
['[shape="hexagon",style="filled",fillcolor="hotpink",label="', '[shape="point",fixedsize=true,height=0.03,width=0.03,style="filled",fillcolor="black",label="' ], // Ñîáûòèÿ
['[shape="box",width=1.5,style="rounded,filled",fillcolor="green",label="', '[shape="cds",width=1.5,style="filled",fillcolor="green",label="' ], // Ôóíêöèè
// lightgreen - https://dreampuf.github.io/GraphvizOnline/# íå ïîíèìàåò
['[shape="note",style="filled",fillcolor="gray90",label="', '[shape="note",style="filled",fillcolor="WhiteSmoke",label="'], // Äîêóìåíòû
['[style="filled",fillcolor="yellow",label="', '[style="filled",fillcolor="yellow",label="' ], // Ðîëè
['[shape="box3d",style="filled",fillcolor="lightblue",label="', '[shape="box3d",style="filled",fillcolor="lightblue",label="' ], // Ñèñòåìû, fillcolor="aqua"
];

const DOTstyleLink = [ // Ëèñò èç Excel (exDOT SmartDesign), íî äëÿ ñîåäèíèòåëåé  
['[style="bold",tailport=s,headport=n,weight=3];', '[style="bold",tailport=e,headport=w,weight=3];' ], // 0 = workflow 
['[style="dashed",tailport=s,headport=w,weight=1];', '[style="dashed",tailport=e,headport=n,weight=1]' ], //1 = HasInDoc
['[style="dashed",tailport=w,headport=n,weight=1];', '[style="dashed",tailport=en,headport=w,weight=1];' ], //2 = HasOutDoc
['[style="solid",tailport=e,headport=w,arrowhead=none,weight=2];', '[style="solid",tailport=s,headport=n,arrowhead=none,weight=2];' ], //3 = Role
]; // Ëèíèÿ ó Cèñòåìû òàêàÿ æå êàê è ó Ðîëè. Òàêæå íå ñòàâèì rank

function Button1()
{

let i;
let j;
let AllDoc = []; //?
for (j = 0; j < 5; j++) { // Ôîðìèðîâàíèå ñïðàâî÷íèêà Äîêóìåíòîâ (âñå íåïîâòîðÿþùèåñÿ äîêóìåíòû)
// Âûçîâ fruits.push(...) ðàâíîçíà÷åí fruits[fruits.length] = ....
 if (table1.getValueFromCoords(nameHasInDoc, j) != "") {
   AllDoc.push (table1.getValueFromCoords(nameHasInDoc, j)) // ïåðâûé èíäåêñ íå ñòðîêà, à ñòîëáåö
 } 
 if (table1.getValueFromCoords(nameHasOutDoc, j) != "") {
 AllDoc.push (table1.getValueFromCoords(nameHasOutDoc, j))
 }
}
const AllDoc2 = Array.from(new Set(AllDoc)); // Ìàññèâ óíèêàëüíûõ èìåí îáúåêòîâ òèïà Äîêóìåíò
 let fig; // ôèãóðà
 let figRole;
 let figSystem;
 let selectElem = document.getElementById("EPC_VAD"); 
 let indexEPC = selectElem.selectedIndex // 0=EPC, 1=VAD

txtStream = StEndStart[indexEPC] + '\n';  // Ñòàðòîâûé digraph G
// Ôîðìèðóåì ôèãóðû Äîêóìåíòîâ (èç ñôîðèìèðîâàííîãî ñïðàâî÷íèêà AllDoc2)
for (j = 0; j < AllDoc2.length; j++) {
 txtStream += AllDoc2[j].replace(/ /ig, '_') + ' ' + DOTstyle [2][indexEPC] + AllDoc2[j].replace(/ /ig, '\\n') + '"];' + '\n'; // 2 = Âõîäÿùèé è Èñõîäÿùèé äîêóìåíòò] â DOTstyle
}

i = 0; 
do { // öèêë ïî ñòðîêàì òàáëèöû ñâÿçåé
 fig = table1.getValueFromCoords(nameEvFun, i) // íàèìåíîâàíèå ñîáûòèÿ èëè ôóíêöèè
 if ( table1.getValueFromCoords(fixTypeEvFun, i) == 'ñîáûòèå') { // ñîáûòèå
    txtStream += fig.replace(/ /ig, '_') + ' ' + DOTstyle [0][indexEPC] + fig.replace(/ /ig, '\\n') + '"];' + '\n'; // 0 = ñîáûòèå â DOTstyle
 } 
 if ( table1.getValueFromCoords(fixTypeEvFun, i) == 'îïåðàöèÿ') { // ôóíêöèÿ
   txtStream += fig.replace(/ /ig, '_') + ' ' + DOTstyle [1][indexEPC] + fig.replace(/ /ig, '\\n') + '"];' + '\n'; // 1 = ôóíêöèÿ â DOTstyle
   if (table1.getValueFromCoords(nameHasInDoc, i) != "") { // Excel: If Not IsEmpty(.Cells(i, nameHasInDoc)) Then ' Åñëè åñòü âõîäíîé äîêóìåíò
    // Âûøå íàðèñîâàëè Âõîäÿùèé äîêóìåíò, òåïåðü åãî íóæíî ñâÿçàòü ñ ôóíêöèåé, ò.å. ðèñóåì ëèíèþ:
    txtStream += table1.getValueFromCoords(nameHasInDoc, i).replace(/ /ig, '_') +' -> ' + fig.replace(/ /ig, '_') + ' ' + DOTstyleLink [1][indexEPC] + '\n';
   } // nameHasInDoc, i) != ""
   
   if (table1.getValueFromCoords(nameHasOutDoc, i) != "") { // Ôóíêöèÿ -> Èñõîäÿùèé äîêóìåíò 
 // ñôîðìèðîâàíî ðàíåå:  txtStream += table1.getValueFromCoords(nameHasOutDoc, i).replace(/ /ig, '_') + ' ' + DOTstyle [2][indexEPC] + table1.getValueFromCoords(nameHasOutDoc, i).replace(/ /ig, '\\n') + '"];' + '\n'; // 2 = Âõîäÿùèé è Èñõîäÿùèé äîêóìåíòò] â DOTstyle
     // Äîáàâëÿåì, ò.ê. âõîäÿùåãî ìîæåò íå áûòü
     txtStream += fig.replace(/ /ig, '_') + ' -> ' + table1.getValueFromCoords(nameHasOutDoc, i).replace(/ /ig, '_') + ' ' + DOTstyleLink [2][indexEPC] + '\n'; // 2 = HasOutDoc. Ðèñóåì ëèíèþ 
   }
   // Äîáàâëÿåì Ðîëè figRole 
   if (table1.getValueFromCoords(nameRole, i) != "") // Åñòü Ðîëü. Îòäåëüíàÿ ôèãóðà Ðîëè ê êàæäîé ôóíêöèè
   {
     figRole = table1.getValueFromCoords(nameRole, i) + i;
     txtStream += figRole.replace(/ /ig, '_') + DOTstyle [3][indexEPC] + table1.getValueFromCoords(nameRole, i).replace(/ /ig, '\\n') + '"];' + '\n'; // 3 = Role â DOTstyle
     txtStream += fig.replace(/ /ig, '_') +  ' -> ' + figRole.replace(/ /ig, '_') + " " + DOTstyleLink [3][indexEPC] + '\n'; // 3 = Role. Ðèñóåì ëèíèþ ê Role 
     
     txtStream += '{rank=same; ' + fig.replace(/ /ig, '_') + ';' + figRole.replace(/ /ig, '_') + ';};\n';    // rank=same;
   }
   
   if (table1.getValueFromCoords(nameSystem, i) != "" && indexEPC != 1) // Åñòü ñèñòåìà and Íå VAD. Îòäåëüíàÿ ôèãóðà Ðîëè ê êàæäîé ôóíêöèè
   {
     //  txtStream.Write ("{rank=same; " & idStr & "; " & Replace(.Cells(i, nameRole), " ", "_") & i & ";};") ' äîáàâëÿåì ê id ðîëè i
     figSystem = table1.getValueFromCoords(nameSystem, i) + i;
     txtStream += figSystem.replace(/ /ig, '_') + DOTstyle [4][indexEPC] + table1.getValueFromCoords(nameSystem, i).replace(/ /ig, '\\n') + '"];' + '\n'; // 4 = system â DOTstyle
     txtStream += fig.replace(/ /ig, '_') +  ' -> ' + figSystem.replace(/ /ig, '_') + " " + DOTstyleLink [3][indexEPC] + '\n'; // 3 = Role. Ðèñóåì ëèíèþ ê Ñèñòåìå 
   } // Âñå òîæå ñàìîå (â ò.÷. DOTstyleLink [3][indexEPC]), òîëüêî áåç rank  
  
  } // table1.getValueFromCoords(fixTypeEvFun, i) == 'îïåðàöèÿ'
  
 // åñëè ýòî íå ïåðâûé ýëåìèåíò, òî äîáàâëÿåì ñâÿçü ñ ïðåäøåäñòâåííèêîì
 if ( i > 0) {
    txtStream += table1.getValueFromCoords(nameEvFun, i-1).replace(/ /ig, '_') +  ' -> ' + fig.replace(/ /ig, '_') + " " + DOTstyleLink [0][indexEPC] + '\n'; // 0 = workflow. Ðèñóåì ëèíèþ workflow 
 } // i > 0
   
  
     
  i++;
} while (i < 5);  //ïîêà íå ïîñëåäíÿÿ ñòðîêà òàáëèöû
txtStream += '}';
//  alert (txtStream);
  console.log(txtStream);
  window.open("https://dreampuf.github.io/GraphvizOnline/#" + txtStream); // https://dreampuf.github.io/GraphvizOnline/#
}

</script>
</body>
</html>
